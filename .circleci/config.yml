version: 2.1

commands:
  docker-login:
    steps:
      - run: docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
  setup-env:
    steps:
      - run: git clone https://github.com/chelovekgenek/ciclismurban-root.git
  setup-vars:
    steps:
      - run: |
          echo "export DOCKER_BUILD_CONFIG=`[ -f ./config/$CIRCLE_BRANCH.env ] && echo $CIRCLE_BRANCH.env || echo default.env`" >> $BASH_ENV
          echo "export DOCKER_BUILD_IMAGE=$DOCKER_USERNAME/ciclismurban:api-$CIRCLE_SHA1" >> $BASH_ENV
          echo "export DOCKER_RELEASE_IMAGE=$DOCKER_USERNAME/ciclismurban:api-$CIRCLE_BRANCH" >> $BASH_ENV
          cat $BASH_ENV
          source $BASH_ENV
  run-script:
    parameters:
      script:
        type: string
      path:
        type: string
        default: ./ciclismurban-root/scripts
    steps:
      - run: |
          chmod +x << parameters.path >>/<< parameters.script >>
          << parameters.path >>/<< parameters.script >>

jobs:
  build:
    machine: true
    steps:
      - checkout
      - docker-login
      - setup-vars
      - run: |
          docker build -t $DOCKER_BUILD_IMAGE --build-arg CONFIG=$DOCKER_BUILD_CONFIG . 
          docker push $DOCKER_BUILD_IMAGE
  deploy-master:
    machine: true
    environment:
      DOCKER_CONTAINER: ciclismurban-api_master
    steps:
      - setup-env
      - setup-vars
      - docker-login
      - run-script:
          script: deploy.sh

workflows:
  version: 2
  build-deploy:
    jobs:
      - build:
          filters:
            branches:
              only:
                - master
      - deploy-master:
          requires:
            - build
          filters:
            branches:
              only: master
